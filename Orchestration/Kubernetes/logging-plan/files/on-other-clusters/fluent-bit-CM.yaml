apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: kube-system
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         5
        Log_Level     info
        Parsers_File  parsers.conf

    @INCLUDE input-containers.conf
    @INCLUDE filters.conf
    @INCLUDE output-gelf.conf

  input-containers.conf: |
    [INPUT]
        Name              tail
        Path              /var/log/containers/*.log          # ← THIS PATH WINS
        Tag               kube.*
        Parser            docker
        DB                /var/fluent-bit/state/tail-containers.db
        Mem_Buf_Limit     50MB
        Skip_Long_Lines   On
        Refresh_Interval  10
        Rotate_Wait       30

  filters.conf: |
    # Drop kube-system early
    [FILTER]
        Name   grep
        Match  kube.*
        Exclude $kubernetes['namespace_name'] '^kube-system$'

    # Standard kubernetes filter – works perfectly with /var/log/containers/*.log
    [FILTER]
        Name               kubernetes
        Match              kube.*
        Kube_URL           https://kubernetes.default.svc:443
        Kube_CA_File       /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File    /var/run/secrets/kubernetes.io/serviceaccount/token
        Merge_Log          On
        Keep_Log           Off
        K8S-Logging.Parser On
        Labels             On
        Annotations        On

    [FILTER]
        Name  modify
        Match *
        Add   cluster_name cluster_prod_50

    [FILTER]
        Name   lua
        Match  kube.*
        script /fluent-bit/scripts/combine_fields.lua
        call   add_diviving_name

  output-gelf.conf: |
    [OUTPUT]
        Name   gelf
        Match  *
        Host   10.10.21.151
        Port   31220
        Mode   tcp

  parsers.conf: |
    [PARSER]
        Name         docker
        Format       json
        Time_Key     time
        Time_Format  %Y-%m-%dT%H:%M:%S.%L%z
        Time_Keep    On