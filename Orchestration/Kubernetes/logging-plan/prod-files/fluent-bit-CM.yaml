apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: kube-system
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush             1
        Log_Level         info
        Parsers_File      parsers.conf
        Daemon            Off

    [INPUT]
        Name              tail
        Path              /var/log/containers/*.log
        Tag               kube.*
        Parser            docker
        DB                /var/log/flb_kube.db
        Mem_Buf_Limit     20MB
        Skip_Long_Lines   On
        Refresh_Interval  5

    # Add Kubernetes metadata
    [FILTER]
        Name                kubernetes
        Match               kube.*
        Merge_Log           On
        Keep_Log            Off
        K8S-Logging.Parser  On
        K8S-Logging.Exclude On

    # EXCLUDE system namespaces (important)
    [FILTER]
        Name       grep
        Match      kube.*
        Exclude    kubernetes.namespace_name kube-system
        Exclude    kubernetes.namespace_name kube-public
        Exclude    kubernetes.namespace_name kube-node-lease

        # Add more if needed:
        #Exclude    kubernetes.namespace_name istio-system
        #Exclude    kubernetes.namespace_name monitoring
        #Exclude    kubernetes.namespace_name cert-manager

    [FILTER]
        Name modify
        Match kube.*
        Add cluster your-cluster-name     #CHANGE THIS

    # Output to Graylog via GELF
    [OUTPUT]
        Name              gelf
        Match             kube.*
        Host              graylog.example.com     #CHANGE THIS
        Port              12201     #CHANGE THIS
        Mode              tcp

        # TLS (optional but recommended)
        tls               Off
        tls.verify        Off
        tls.debug         0
        #tls.ca_file      /fluent-bit/tls/ca.pem
        #tls.crt_file     /fluent-bit/tls/tls.crt
        #tls.key_file     /fluent-bit/tls/tls.key

  parsers.conf: |
    [PARSER]
        Name        docker
        Format      json
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L